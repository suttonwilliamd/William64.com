---
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';

const pageTitle = "Blog | William Sutton";
const pageDescription = "Blog posts and tutorials by William Sutton, a hobbyist developer.";

import { getCollection } from 'astro:content';

const posts = await getCollection('posts');

posts.sort((a, b) => {
  const dateA = new Date(a.data.publishedDate).valueOf();
  const dateB = new Date(b.data.publishedDate).valueOf();
  return dateB - dateA;
});

const featuredPosts = posts.filter(post => post.data.featured);
const regularPosts = posts.filter(post => !post.data.featured);

const categories = [...new Set(posts.map(post => post.data.category || 'Uncategorized').filter(Boolean))];
const allTags = [...new Set(posts.flatMap(post => post.data.tags || []))];
const POSTS_PER_PAGE = 10;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body class="bg-background text-text font-sans">
    <div class="min-h-screen flex flex-col">
      <header class="border-b border-border pb-4 mb-6">
        <Navigation />
        <p class="text-sm text-text-secondary mt-3">Blog posts and tutorials on web development.</p>
      </header>

      <main class="container">
        <div class="blog-header mb-12">
          <h2 class="text-3xl font-bold mb-2">Blog</h2>
          <p class="text-text-secondary text-lg max-w-2xl mb-8">
            Writing on software engineering, systems thinking, and retro tech.
          </p>
        </div>

        {posts.length === 0 ? (
          <div class="terminal-block" style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--space-6); font-family: var(--font-family-mono);">
            <div style="color: var(--color-text-tertiary); margin-bottom: var(--space-3);">
              <span style="color: #00ff00;">william64@portfolio</span>:<span style="color: #3399ff;">~$</span> ls blog/
            </div>
            <p style="color: var(--color-text-secondary); margin: 0 0 var(--space-4) 0;">
              blog/ is empty. I'm still drafting my first posts on software engineering, systems, and retro tech.
            </p>
            <p style="color: var(--color-text-tertiary); margin: 0;">
              In the meantime: <a href="/projects" style="color: var(--color-primary);">View projects on GitHub →</a>
            </p>
          </div>
        ) : (
          <div class="blog-layout">
            <div class="blog-main">
              {featuredPosts.length > 0 && (
                <section class="featured-section mb-12">
                  <h3 class="text-xl font-semibold mb-6 text-primary">Featured</h3>
                  <div class="featured-grid">
                    {featuredPosts.slice(0, 2).map((post) => {
                      return (
                        <article class="featured-card">
                          <div class="featured-content">
                            <div class="post-meta mb-3">
                              <span class="text-text-tertiary text-sm">{post.data.publishedDate.toISOString().slice(0, 10)}</span>
                              <span class="text-text-tertiary text-sm mx-2">•</span>
                              <span class="text-primary text-sm">{post.data.category}</span>
                            </div>
                            <h4 class="text-2xl font-bold mb-3">
                              <a href={`/blog/posts/${post.id}`} class="hover:text-primary transition-colors">
                                {post.data.title}
                              </a>
                            </h4>
                            <p class="text-text-secondary mb-4">{post.data.summary}</p>
                            <div class="flex gap-2 flex-wrap">
                              {post.data.tags?.slice(0, 3).map(tag => (
                                <span class="tag">{tag}</span>
                              ))}
                            </div>
                          </div>
                        </article>
                      );
                    })}
                  </div>
                </section>
              )}

              <section class="posts-section">
                <h3 class="text-xl font-semibold mb-6">Recent Posts</h3>
                <div class="posts-list">
                  {regularPosts.slice(0, POSTS_PER_PAGE).map((post) => {
                    return (
                      <article class="post-card">
                        <div class="post-meta mb-2">
                          <span class="text-text-tertiary text-sm">{post.data.publishedDate.toISOString().slice(0, 10)}</span>
                          <span class="text-text-tertiary text-sm mx-2">•</span>
                          <span class="text-secondary text-sm">{post.data.category}</span>
                        </div>
                        <h4 class="text-xl font-bold mb-2">
                          <a href={`/blog/posts/${post.id}`} class="hover:text-primary transition-colors">
                            {post.data.title}
                          </a>
                        </h4>
                        <p class="text-text-secondary mb-3">{post.data.summary}</p>
                        <div class="flex gap-2 flex-wrap">
                          {post.data.tags?.slice(0, 4).map(tag => (
                            <span class="tag tag-sm">{tag}</span>
                          ))}
                        </div>
                      </article>
                    );
                  })}
                </div>

                {regularPosts.length > POSTS_PER_PAGE && (
                  <div class="pagination mt-8">
                    <span class="text-text-tertiary">Showing {POSTS_PER_PAGE} of {regularPosts.length} posts</span>
                  </div>
                )}
              </section>
            </div>

            <aside class="blog-sidebar">
              <div class="sidebar-section">
                <h4 class="font-semibold mb-4">Categories</h4>
                <div class="category-list">
                  {categories.map(category => (
                    <a href={`/blog/category/${category.toLowerCase().replace(/\s+/g, '-')}`} class="category-link">
                      {category}
                    </a>
                  ))}
                </div>
              </div>

              <div class="sidebar-section">
                <h4 class="font-semibold mb-4">Popular Tags</h4>
                <div class="tag-list">
                  {allTags.slice(0, 15).map(tag => (
                    <a href={`/blog/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`} class="tag tag-outline">
                      {tag}
                    </a>
                  ))}
                </div>
              </div>

              <div class="sidebar-section">
                <h4 class="font-semibold mb-4">About</h4>
                <p class="text-text-secondary text-sm mb-4">
                  I write about software engineering, clean architecture, and modern web development practices.
                </p>
                <a href="/about" class="btn btn-primary w-full">Learn More</a>
              </div>
            </aside>
          </div>
        )}
      </main>

      <Footer />
    </div>
  </body>
</html>

<style>
  .blog-header {
    padding-bottom: var(--space-6);
    border-bottom: 1px solid var(--color-border);
  }

  .blog-layout {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: var(--space-8);
  }

  .blog-main {
    min-width: 0;
  }

  .blog-sidebar {
    position: sticky;
    top: var(--space-8);
    height: fit-content;
  }

  .featured-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-6);
  }

  .featured-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    transition: all var(--transition-normal);
  }

  .featured-card:hover {
    border-color: var(--color-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .post-card {
    background: transparent;
    border: 1px solid transparent;
    border-bottom: 1px solid var(--color-border);
    padding: var(--space-6) 0;
    transition: all var(--transition-normal);
  }

  .post-card:last-child {
    border-bottom: none;
  }

  .post-card:hover {
    background: var(--color-surface);
    border-color: var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-6);
    margin: 0 calc(-1 * var(--space-6));
  }

  .post-meta {
    display: flex;
    align-items: center;
  }

  .tag {
    display: inline-block;
    padding: var(--space-xs) var(--space-3);
    background: rgba(0, 229, 160, 0.1);
    color: var(--color-primary);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    transition: all var(--transition-fast);
  }

  .tag:hover {
    background: var(--color-primary);
    color: var(--color-background);
  }

  .tag-sm {
    padding: 2px var(--space-2);
    font-size: 0.7rem;
  }

  .tag-outline {
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-text-secondary);
  }

  .tag-outline:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
    background: rgba(0, 229, 160, 0.1);
  }

  .sidebar-section {
    margin-bottom: var(--space-8);
  }

  .category-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .category-link {
    display: block;
    padding: var(--space-2) var(--space-3);
    color: var(--color-text-secondary);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    transition: all var(--transition-fast);
  }

  .category-link:hover {
    background: var(--color-surface);
    color: var(--color-text);
  }

  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-3) var(--space-5);
    background: var(--color-surface);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-family: var(--font-family-base);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-normal);
    text-decoration: none;
  }

  .btn-primary {
    background: var(--color-primary);
    color: var(--color-background);
    border-color: var(--color-primary);
  }

  .btn-primary:hover {
    background: var(--color-primary-hover);
    border-color: var(--color-primary-hover);
  }

  .w-full {
    width: 100%;
  }

  @media (max-width: 1024px) {
    .blog-layout {
      grid-template-columns: 1fr;
    }

    .blog-sidebar {
      position: static;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-6);
    }

    .sidebar-section {
      margin-bottom: 0;
    }
  }

  @media (max-width: 768px) {
    .featured-grid {
      grid-template-columns: 1fr;
    }

    .blog-sidebar {
      grid-template-columns: 1fr;
    }
  }
</style>
