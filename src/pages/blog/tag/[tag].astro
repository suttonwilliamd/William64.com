---
import Navigation from '../../../components/Navigation.astro';
import Footer from '../../../components/Footer.astro';

export async function getStaticPaths() {
  const posts = await Astro.glob('../../../pages/posts/*.mdx');
  
  const tags = [...new Set(posts.flatMap(post => post.frontmatter.tags || []))];
  
  return tags.map(tag => ({
    params: { tag: tag.toLowerCase().replace(/\s+/g, '-') },
    props: { tag, posts },
  }));
}

const { tag, posts } = Astro.props;

const tagPosts = posts
  .filter(post => post.frontmatter.tags && post.frontmatter.tags.some(t => t.toLowerCase().replace(/\s+/g, '-') === tag.toLowerCase().replace(/\s+/g, '-')))
  .sort((a, b) => new Date(b.frontmatter.date) - new Date(a.frontmatter.date));

function getSlug(post) {
  return post.file.split('/').pop().replace('.mdx', '');
}

const pageTitle = `Posts tagged with "${tag}" | William64.com`;
const pageDescription = `Browse all articles tagged with ${tag} on William64.com`;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body class="bg-background text-text font-sans">
    <div class="min-h-screen flex flex-col">
      <header class="border-b border-border pb-6 mb-8">
        <h1 class="text-4xl font-bold mb-2">
          <a href="/" class="gradient-text hover:opacity-80 transition-opacity">William64.com</a>
        </h1>
        <Navigation />
      </header>

      <main class="container">
        <div class="tag-header mb-8">
          <a href="/blog" class="back-link">← All Posts</a>
          <div class="tag-display mt-4">
            <span class="tag-badge">{tag}</span>
          </div>
          <p class="text-text-secondary mt-2">{tagPosts.length} post{tagPosts.length !== 1 ? 's' : ''}</p>
        </div>

        <div class="posts-list">
          {tagPosts.map((post) => {
            const slug = getSlug(post);
            return (
              <article class="post-card">
                <div class="post-meta mb-2">
                  <span class="text-text-tertiary text-sm">{post.frontmatter.date}</span>
                  <span class="text-text-tertiary text-sm mx-2">•</span>
                  <span class="text-secondary text-sm">{post.frontmatter.category}</span>
                </div>
                <h3 class="text-xl font-bold mb-2">
                  <a href={`/blog/posts/${slug}`} class="hover:text-primary transition-colors">
                    {post.frontmatter.title}
                  </a>
                </h3>
                <p class="text-text-secondary mb-3">{post.frontmatter.summary}</p>
                {post.frontmatter.tags && post.frontmatter.tags.length > 0 && (
                  <div class="flex gap-2 flex-wrap">
                    {post.frontmatter.tags.slice(0, 4).map(t => (
                      <span class={`tag ${t.toLowerCase().replace(/\s+/g, '-') === tag.toLowerCase().replace(/\s+/g, '-') ? 'tag-active' : ''}`}>
                        {t}
                      </span>
                    ))}
                  </div>
                )}
              </article>
            );
          })}
        </div>

        {tagPosts.length === 0 && (
          <div class="empty-state">
            <p class="text-text-secondary">No posts found with this tag.</p>
            <a href="/blog" class="btn btn-primary mt-4">Browse All Posts</a>
          </div>
        )}
      </main>

      <Footer />
    </div>
  </body>
</html>

<style>
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .tag-header {
    padding-bottom: var(--space-6);
    border-bottom: 1px solid var(--color-border);
  }

  .tag-badge {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    background: rgba(0, 229, 160, 0.1);
    color: var(--color-primary);
    border-radius: var(--radius-full);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-medium);
  }

  .posts-list {
    display: flex;
    flex-direction: column;
  }

  .post-card {
    background: transparent;
    border: 1px solid transparent;
    border-bottom: 1px solid var(--color-border);
    padding: var(--space-6) 0;
    transition: all var(--transition-normal);
  }

  .post-card:last-child {
    border-bottom: none;
  }

  .post-card:hover {
    background: var(--color-surface);
    border-color: var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-6);
    margin: 0 calc(-1 * var(--space-6));
  }

  .post-meta {
    display: flex;
    align-items: center;
  }

  .tag {
    display: inline-block;
    padding: var(--space-xs) var(--space-3);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    color: var(--color-text-secondary);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    transition: all var(--transition-fast);
  }

  .tag-active {
    background: rgba(0, 229, 160, 0.1);
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-12) 0;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-3) var(--space-5);
    background: var(--color-surface);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-normal);
    text-decoration: none;
  }

  .btn-primary {
    background: var(--color-primary);
    color: var(--color-background);
    border-color: var(--color-primary);
  }

  .mt-4 {
    margin-top: var(--space-4);
  }
</style>
